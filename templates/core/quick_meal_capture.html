{% extends 'base.html' %}

{% block title %}Quick - Captura Rápida{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-4">
        <div class="card border-0 shadow-lg">
            <div class="card-body text-center p-5">
                <div class="mb-4">
                    <i class="fas fa-camera text-primary" style="font-size: 3rem;"></i>
                </div>
                
                <h3 class="card-title mb-4 fw-bold text-primary">Quick Capture</h3>
                <p class="text-muted mb-4">Toma una foto o sube una imagen de tu comida para análisis instantáneo</p>
                
                <!-- Image Upload Area -->
                <div class="upload-area mb-4" id="uploadArea">
                    <div class="upload-content">
                        <i class="fas fa-cloud-upload-alt text-muted mb-3" style="font-size: 2rem;"></i>
                        <p class="text-muted mb-2">Arrastra una imagen aquí o</p>
                        <button type="button" class="btn btn-outline-primary" id="selectImageBtn">
                            <i class="fas fa-image me-2"></i>Seleccionar Imagen
                        </button>
                        <input type="file" id="imageInput" accept="image/*" capture="environment" style="display: none;">
                    </div>
                    
                    <!-- Preview Area -->
                    <div id="imagePreview" style="display: none;">
                        <img id="previewImg" src="" alt="Preview" class="img-fluid rounded mb-3" style="max-height: 200px;">
                        <div class="d-flex gap-2 justify-content-center">
                            <button type="button" class="btn btn-primary" id="analyzeBtn">
                                <i class="fas fa-magic me-2"></i>Analizar
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="changeImageBtn">
                                <i class="fas fa-sync me-2"></i>Cambiar
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Loading State -->
                <div id="loadingState" style="display: none;">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="text-muted">Analizando tu comida con IA...</p>
                </div>
                
                <!-- Back Button -->
                <div class="mt-4">
                    <a href="{% url 'core:dashboard' %}" class="btn btn-link text-muted">
                        <i class="fas fa-arrow-left me-2"></i>Volver al Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.upload-area {
    border: 2px dashed #e5e7eb;
    border-radius: 12px;
    padding: 2rem;
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-area:hover {
    border-color: var(--primary-color);
    background-color: #f8fafc;
}

.upload-area.dragover {
    border-color: var(--primary-color);
    background-color: #f0f9ff;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadArea');
    const imageInput = document.getElementById('imageInput');
    const selectImageBtn = document.getElementById('selectImageBtn');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const changeImageBtn = document.getElementById('changeImageBtn');
    const loadingState = document.getElementById('loadingState');
    let selectedFile = null;
    let isProcessing = false; // Flag para evitar múltiples llamadas

    // Click to select image
    selectImageBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Evitar propagación del evento
        if (!isProcessing) {
            imageInput.click();
        }
    });
    uploadArea.addEventListener('click', (e) => {
        // Solo activar si no se hizo clic en el botón específicamente y no estamos procesando
        if (!isProcessing && (e.target === uploadArea || (e.target.closest('.upload-content') && !e.target.closest('#selectImageBtn')))) {
            imageInput.click();
        }
    });

    // Drag and drop functionality
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleImageSelect(files[0]);
        }
    });

    // File input change
    imageInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleImageSelect(e.target.files[0]);
        }
    });

    // Handle image selection
    function handleImageSelect(file) {
        if (!file.type.startsWith('image/')) {
            alert('Por favor selecciona un archivo de imagen válido.');
            return;
        }

        selectedFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
            previewImg.src = e.target.result;
            document.querySelector('.upload-content').style.display = 'none';
            imagePreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    // Change image button
    changeImageBtn.addEventListener('click', () => {
        if (isProcessing) return; // No permitir cambios durante procesamiento
        
        selectedFile = null;
        imagePreview.style.display = 'none';
        document.querySelector('.upload-content').style.display = 'block';
        imageInput.value = '';
    });

    // Analyze button
    analyzeBtn.addEventListener('click', async () => {
        if (!selectedFile || isProcessing) return;

        isProcessing = true; // Marcar como procesando
        
        // Show loading state
        imagePreview.style.display = 'none';
        loadingState.style.display = 'block';

        try {
            const formData = new FormData();
            formData.append('image', selectedFile);

            const response = await fetch('{% url "core:api_analyze_image_enhanced" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });

            const data = await response.json();

            if (data.success) {
                // Redirect to summary page
                window.location.href = `/quick/summary/${data.analysis_id}/`;
            } else {
                throw new Error(data.error || 'Error en el análisis');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al analizar la imagen. Inténtalo de nuevo.');
            
            // Reset to image preview
            loadingState.style.display = 'none';
            imagePreview.style.display = 'block';
        } finally {
            isProcessing = false; // Resetear flag de procesamiento
        }
    });
});
</script>
{% endblock %} 